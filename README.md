<h1>‚òÅÔ∏è FEXCO DevOps Take-Home Assessment</h1>

<h2>üéØ Objective</h2>
<p>
Provision an <strong>Azure Kubernetes Service (AKS)</strong> cluster using <strong>Terraform</strong>, 
deploy a simple <strong>Helm workload</strong> to it, and manage the lifecycle using a 
<strong>GitHub Actions CI/CD pipeline</strong>.
</p>

<hr>

<h2>‚öôÔ∏è Prerequisites</h2>
<ul>
  <li>Terraform CLI</li>
  <li>GitHub CLI</li>
  <li>Azure CLI</li>
  <li>kubectl</li>
  <li>Code Editor (Visual Studio)</li>
</ul>

<p><strong>Accounts required:</strong> GitHub and Azure</p>

<p><strong>Versions Used:</strong></p>
<ul>
  <li>Terraform v1.13.4</li>
  <li>git 2.50.1</li>
  <li>azure-cli 2.78.0</li>
  <li>kubectl v1.34.1</li>
</ul>

<h3>CLI login</h3>
<pre><code>az login</code></pre>

<h3>Kubernetes</h3>
<pre><code># Get AKS cluster credentials (admin context)
az aks get-credentials \
  --resource-group &lt;RESOURCE_GROUP&gt; \
  --name &lt;CLUSTER_NAME&gt; \
  --admin
</code></pre>

<hr>

<h2>üß± Azure Requirements</h2>
<ul>
  <li>Azure subscription with rights to create resource groups, AKS, and networking</li>
  <li>Service Principal or OIDC setup for authentication in GitHub Actions</li>
  <li>Storage account and container for Terraform remote backend (configured in <code>backend.tf</code>)</li>
</ul>

<hr>

<h2>üìÅ File Definitions</h2>

<h3>main.tf</h3>
<p>Core infrastructure definition ‚Äî includes creation of the Azure Resource Group, AKS cluster, and Helm deployment (Grafana).</p>

<h3>providers.tf</h3>
<p>Declares all Terraform providers used (AzureRM, Kubernetes, Helm). Configures authentication and provider aliases.</p>

<h3>backend.tf</h3>
<p>Defines the Terraform backend configuration for state storage in Azure Storage.</p>

<h3>variables.tf</h3>
<p>Contains input variables such as resource group, location, and cluster name.</p>

<h3>outputs.tf</h3>
<p>Exports key values after deployment for debugging or chaining modules.</p>

<h3>monitor.tf</h3>
<p>Deploys monitoring components ‚Äî Log Analytics, metrics, and alerts.</p>

<h3>net-policy.tf</h3>
<p>Defines the Kubernetes Network Policy (allows only HTTP on port 80).</p>

<h3>helm/</h3>
<p>Contains Helm configuration, typically including <code>values.yaml</code>.</p>

<h3>.gitignore</h3>
<p>Excludes sensitive and autogenerated files from version control.</p>

<h3>.github/workflows/terraform.yml</h3>
<p>Defines the Terraform CI/CD pipeline for GitHub Actions (plan, apply, destroy).</p>

<h3>.github/pull_request_template.md</h3>
<p>Standardizes pull request descriptions and review checklists.</p>

<hr>

<h2>üöÄ Setup Steps &amp; Pipeline Triggers</h2>

<ol>
  <li>
    <strong>Clone the repository:</strong><br>
    <pre><code>git clone https://github.com/cpelayo/fexco-devops
cd fexco-devops</code></pre>
  </li>

  <li>
    <strong>Set GitHub Secrets:</strong><br>
    ARM_CLIENT_ID, ARM_CLIENT_SECRET, ARM_TENANT_ID, ARM_SUBSCRIPTION_ID
  </li>

  <li>
    <strong>Pipeline Triggers:</strong>
    <ul>
      <li>Runs automatically on push to master</li>
      <li>Can be triggered manually in GitHub Actions</li>
      <li>Runs when a PR is created</li>
    </ul>
  </li>

  <li>
    <strong>Pipeline Stages:</strong>
    <ul>
      <li><strong>Lint &amp; Validate:</strong> Runs <code>terraform fmt</code> and <code>terraform validate</code></li>
      <li><strong>Plan:</strong> Generates and uploads a Terraform plan</li>
      <li><strong>Apply:</strong> Manual approval required</li>
      <li><strong>Destroy:</strong> Manual approval required</li>
    </ul>
  </li>
</ol>

<hr>

<h2>üîç How to Verify the Deployed Workload</h2>

<ol>
  <li>Retrieve AKS credentials:
<pre><code>az aks get-credentials \
  --resource-group aks-demo-rg \
  --name aks-demo-cluster \
  --admin
</code></pre>
  </li>
  <li>List pods:
<pre><code>kubectl get pods -A</code></pre>
  </li>
  <li>Check LoadBalancer service:
<pre><code>kubectl get svc</code></pre>
Example:
<pre><code>NAME    TYPE           CLUSTER-IP     EXTERNAL-IP     PORT(S)        AGE
nginx   LoadBalancer   10.0.123.45    20.12.34.56     80:31000/TCP   2m
</code></pre>
  </li>
  <li>Open the EXTERNAL-IP in your browser to verify the workload.</li>
</ol>

<hr>

<h2>üß® Teardown Instructions</h2>
<ol>
  <li>Go to <strong>GitHub Actions ‚Üí Terraform CI/CD</strong></li>
  <li>Select the same run that applied the plan</li>
  <li>Approve the <strong>Destroy</strong> stage in <em>Review Deployments</em></li>
</ol>

<hr>

<h2>üß© Network Policy Test</h2>

<pre><code># Connect to AKS
az aks get-credentials \
  --resource-group aks-demo-rg \
  --name aks-demo-cluster \
  --admin

# Create test Pod on port 5678
kubectl run test-server --image=python:3.9-slim --restart=Never \
--port=5678 \
--command -- python -m http.server 5678
</code></pre>

<p>Get the test pod IP and Grafana ID:</p>
<pre><code>kubectl get pod -o wide</code></pre>

<p>Connect to Grafana pod and test:</p>
<pre><code>kubectl exec -it grafana-&lt;ID&gt; -- sh
curl -v http://&lt;test-server&gt;</code></pre>

<p><strong>Expected result:</strong> Timeout (policy enforced)</p>

<p>Then delete the policy and retest:</p>
<pre><code>kubectl delete networkpolicy allow-http-only -n default
kubectl exec -it grafana-&lt;ID&gt; -- sh
curl -v http://&lt;test-server&gt;
</code></pre>

<hr>

<h2>‚öñÔ∏è Design Trade-offs and Shortcuts</h2>
<ul>
  <li>Used Service Principal instead of OIDC for simplicity</li>
  <li>Single-node AKS cluster to reduce cost</li>
  <li>Simple Helm chart (Grafana) to focus on CI/CD</li>
  <li>Azure remote backend for Terraform state</li>
  <li>No TLS cert manager (optional stretch goal)</li>
  <li>Configured basic CPU alert and Network Policy</li>
</ul>

<h2>üå± Future Improvements</h2>
<ul>
  <li>Add TLS with self-signed certificates for ingress</li>
  <li>Add observability with Prometheus and Grafana</li>
  <li>Implement multi-environment setup using Terraform workspaces</li>
</ul>